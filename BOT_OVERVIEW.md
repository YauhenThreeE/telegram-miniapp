# Обзор Telegram-бота

Этот документ описывает, как устроен бот: конфигурация, данные, основные сценарии, используемые промты для LLM и идеи для улучшений.

## Запуск и окружение
- Точка входа: `bot/main.py` (`python -m bot.main`).
- Конфиг грузится через `bot/config.py` из `.env`: обязательный `TELEGRAM_BOT_TOKEN`, опциональные `DATABASE_URL` (по умолчанию `sqlite+aiosqlite:///bot.db`) и `OPENAI_API_KEY`/`LLM_API_KEY`.
- Лонгполлинг через Aiogram v3, `parse_mode="HTML"`.
- Сервисы `ai_service` (оценка еды) и `ai_dietitian_service` (чат и рецепты) навешиваются на объект бота. Через `bot.session_maker` хендлеры получают доступ к БД.

## Данные и хранилище
- БД: SQLite (или другая через `DATABASE_URL`), SQLAlchemy Async.
- Модели (`bot/models.py`):
  - `User`: профиль (Telegram ID, язык, пол, дата рождения, рост/вес, цель, диагнозы, аллергии, лекарства, активность).
  - `Meal`: приём пищи (тип, текст/фото, калории и макро, заметки ИИ).
  - `WaterIntake`: записи воды (мл, дата/время).
  - `WeightLog`: замеры веса.
  - `ConversationMessage`: история диалога с диетологом ИИ.
  - `Recipe`: пользовательские рецепты.
- Создание схемы: `bot/db.py` (`setup_database`, `init_db`). Сессии выдаются через `get_session_maker(bot)`.

## Локализация и клавиатуры
- Языки: `en`, `ru`, `pl` (`bot/i18n.py`). Функция `t(lang, key)` выбирает перевод; если ключа нет — падает на английский.
- Основные клавиатуры: `bot/keyboards.py` (выбор языка, меню, тип приёма, пресеты воды, редактирование профиля и т.д.).

## Основные сценарии и хендлеры
- `/start` (`bot/handlers/start.py`): выбор языка, создание пользователя (если нет) и пошаговый онбординг (пол, дата рождения, рост/вес, цель, диагнозы, лекарства, аллергии, активность). Данные сохраняются в `User`.
- `/profile` (`bot/handlers/profile.py`): вывод профиля + инлайн-редактирование веса, роста, активности и цели.
- Лог еды текстом (`/meal`, `/food`) (`bot/handlers/food.py`):
  - Выбор типа (завтрак/обед/ужин/перекус), ввод свободного текста.
  - Вызов `AiNutritionService.estimate_meal_from_text` → сохраняет `Meal` с оценкой калорий/макро.
- Лог еды по фото (`/photo_meal`, `/meal_photo`, `/mealpic`) (`bot/handlers/photo_meal.py`):
  - Выбор типа, ожидание фото, опциональный текст в caption.
  - Скачивание файла, вызов `estimate_meal_from_photo` (если доступен), сохранение `Meal` с `is_from_photo=True` и `photo_file_id`.
- Вода (`/water`) (`bot/handlers/water.py`): пресеты 200/250/300/500 мл или произвольное число, суммирует воду за день.
- Вес (`/weight`) (`bot/handlers/weight.py`): сохраняет `WeightLog`, обновляет `User.current_weight_kg`, выводит дельту к прошлому значению и к цели (если есть).
- Статистика (`/stats`) (`bot/handlers/stats.py`): суммирует калории/макро за сегодня, воду за день и последний вес. `/reset_stats` чистит сегодняшние `Meal` и `WaterIntake`, `/reset_all` — все `Meal`/`WaterIntake`/`WeightLog`.
- Рецепты (`/recipes`) (`bot/handlers/recipes.py`): список последних 10, добавление/просмотр/удаление/редактирование. Поддерживает генерацию черновика рецепта через ИИ (кнопка «Ask AI to draft»).
- Чат с диетологом (`/ask`) (`bot/handlers/ask.py`): сохраняет вопрос/ответ в `ConversationMessage`, перед отправкой подтягивает последние логи еды/воды/веса и сообщения.
- `/help` — текст помощи; `/delete_me` — удаляет профиль и все связанные записи; `misc.py` — ответ на неизвестный текст.

## Используемые промты и поведение LLM
- `bot/services/ai_nutrition.py`:
  - `estimate_meal_from_text`: system prompt — «You are a nutrition analyzer… Respond JSON with keys {calories, protein_g, fat_g, carbs_g, fiber_g, sugar_g, ai_notes}…». В user prompt включается язык и описание блюда. `response_format={"type": "json_object"}`. Модель `gpt-4o-mini`. При ошибке или отсутствии ключа — заглушка: ~500 ккал, 20/15/60 макросы, `ai_notes` с пояснением.
  - `estimate_meal_from_photo`: system prompt аналогичен, но просит оценить по фото (base64), формат JSON. Если нет ключа/байтов или ошибка — та же заглушка с метаданными фото.
- `bot/services/ai_dietitian.py`:
  - `generate_reply`: system prompt — «You are an AI nutrition coach and dietitian assistant. You are NOT a doctor. Provide safe, general educational guidance. Be concise (4-6 sentences). If symptoms are serious, suggest talking to a doctor.» User контекст включает профиль (пол, возраст, рост/веса/цель, диагнозы/медикаменты/аллергии, активность, цель), последние 5 приёмов (только текст), последние записи воды и веса, 10 последних сообщений, язык и текущий вопрос. Модель `gpt-4o-mini`. При ошибке или без ключа — языковой фолбек с общими рекомендациями и дисклеймером.
  - `suggest_recipe`: system prompt — «You help home cooks… concise recipe with ingredients list and 4-6 numbered steps… plain text». User prompt: заголовок + язык. Фолбек — короткий базовый рецепт на нужном языке.
- Оба сервиса мягко деградируют: без `OPENAI_API_KEY` работают на локальных заглушках, сохраняя структуру данных.

## Где что лежит
- `bot/main.py` — инициализация конфига, БД, сервисов и маршрутизаторов, запуск поллинга.
- `bot/db.py` — engine/session, `init_db` создаёт схемы.
- `bot/models.py` — ORM-модели (см. выше).
- `bot/i18n.py`, `bot/keyboards.py` — тексты и клавиатуры.
- `bot/handlers/*` — все пользовательские сценарии.
- `bot/services/*` — интеграции с LLM (или их заглушки).
- `bot/db.py:get_session_maker` — гарантирует, что хендлеры берут корректный sessionmaker даже если модульный `async_session_maker` ещё не установлен.

## Что можно улучшить
- Архитектура:
  - Вынести проверку пользователя/языка и подстановку `lang` в middleware, чтобы все хендлеры получали `user` и `lang` из `event.ctx`. Добавить middleware на сохранение `session_maker` в контекст вместо модуля.
  - Ввести слой сервисов/юзкейсов (meal_log_service, water_service и т.д.) с чистыми функциями; хендлеры превращаются в thin controllers (валидация входа → вызов сервиса → ответ).
  - Вынести текстовые константы клавиатур, лимиты (макс. длина текста рецепта/описаний) и бизнес-настройки в `settings.py` или `config/*.yaml` с единым доступом (например, pydantic Settings).
  - Разнести i18n-ключи по feature-модулям или использовать gettext/ICU, чтобы уменьшить риск рассинхронизации ключей.
- Безопасность и UX:
  - Ограничить размер и формат загружаемых фото (MIME/размер файла), резать/сжимать перед отправкой в LLM; хранить ссылку на сжатую копию.
  - Добавить rate limit / flood control на пользователя и глобально; ошибки — с дружелюбными сообщениями.
  - Включить централизованный трекинг ошибок (sentry/opentelemetry), логировать ключевые бизнес-события и промты/ответы LLM с редактированием PII.
  - Добавить антиспам/anti-DoS для `/ask` (cooldown) и для загрузки фото (ограничение частоты).
- Данные:
  - Создать индексы по `created_at`/`datetime` для фильтраций «за сегодня» и последних записей.
  - Хранить `language` для `Meal`/`Recipe` и фиксировать источник (text/photo/ai) как enum для аналитики.
  - Нормализовать активность/цели/тип приёма в enums; добавить проверки допустимых значений на уровне схемы/ORM и миграций.
  - Подготовить Alembic и миграции; seed-скрипты для локали и дефолтных значений.
- AI:
  - Расширить промты `ai_dietitian` целевыми калориями/макро из профиля, трендами веса, активностью; дать структурированный output (JSON) и форматировать ответ уже в боте.
  - В `ai_nutrition` перейти на OpenAI function calling/tools с строгой схемой и валидацией; падать на безопасный фолбек при несоответствии.
  - Кешировать оценки фото (hash файла) и сохранять путь к локальной копии, чтобы не платить дважды и дать повторное использование.
  - Добавить маленькую защиту от prompt injection (обрезка длины, удаление управляющих символов) и лимиты токенов.
- Фичи:
  - Реализовать «Холодильник» (хранить продукты/остатки), «Бюджет» (лимиты и учёт стоимости), полноценный лог еды из меню вместо заглушек.
  - Напоминания (вода/еда/вес), ежедневные дайджесты, цели по воде и прогресс-бар, streaks.
  - Экспорт/импорт данных, история статистики с графиками (по весу/калориям/воде), фильтры по периодам.
  - Улучшить UX рецептов: теги/категории, поиск, шаринг, версии рецептов, превью макро из ингредиентов.
- Развёртывание и DevOps:
  - Dockerfile + docker-compose, healthcheck; gunicorn/uvicorn + webhook-режим (reverse proxy), readiness/liveness.
  - Линтер/форматер (ruff+black+isort), type-check (mypy/pyright), тесты на хендлеры/сервисы с pytest+aiogram test utils и фикстурой для БД.
  - CI (GitHub Actions) с матрицей python версий, кешем pip, автолинтом/тестами; pre-commit hooks.
  - Наблюдаемость: structured logging, metrics (prometheus/otlp), трассировка ключевых запросов к LLM/БД.
